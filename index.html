<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RakStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --red: #ff3b30; --green: #30d158; --gray: #8e8e93; --gold: #ffd700; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; transition: background 0.5s; }
        
        /* --- SEASONAL MODES CSS --- */
        /* Snow (New Year) */
        .snow-flake { position: fixed; color: white; top: -10px; animation: fall linear infinite; z-index: 50; pointer-events: none; opacity: 0.8; }
        @keyframes fall { to { transform: translateY(105vh); } }
        
        /* Halloween */
        body.mode-halloween { background: #1a0500; --red: #ff6600; --card: #2d1405; }
        .ghost { position: fixed; color: rgba(255,255,255,0.1); animation: floatGhost 10s infinite linear; z-index: 1; pointer-events: none; font-size: 40px; }
        @keyframes floatGhost { 0% { transform: translate(-10vw, 100vh); } 100% { transform: translate(110vw, -10vh); } }

        /* Autumn */
        body.mode-autumn { background: #1a1000; --green: #d48806; }
        .leaf { position: fixed; color: #d48806; animation: fallRotate 8s linear infinite; z-index: 50; pointer-events: none; }
        @keyframes fallRotate { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(105vh) rotate(360deg); } }

        /* Summer */
        body.mode-summer { background: #001a1a; --red: #ffcc00; }
        .sun-flare { position: fixed; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,204,0,0.4) 0%, rgba(0,0,0,0) 70%); z-index: 0; pointer-events: none; }

        /* Spring */
        body.mode-spring { background: #0f1a15; --red: #ff69b4; }
        .flower { position: fixed; color: #ff69b4; animation: fall 12s linear infinite; z-index: 50; pointer-events: none; font-size: 10px; }

        /* --- UI ELEMENTS --- */
        header { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--card); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 24px; font-weight: 900; color: var(--red); text-transform: uppercase; }
        .burger { font-size: 24px; cursor: pointer; }
        
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Admin Tabs */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .admin-tab { background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .admin-tab.active { background: var(--red); color: white; }

        /* Cards */
        .level-card { background: linear-gradient(135deg, var(--red), #ff9f0a); padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); }
        .xp-bar-bg { background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .xp-bar-fill { background: white; height: 100%; width: 0%; transition: 1s; }

        .bonus-card { background: #333; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--gold); }
        .bonus-val { color: var(--gold); font-size: 24px; font-weight: bold; }

        /* Lists */
        .trans-item { background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; font-size: 13px; border-left: 3px solid #555; }
        .trans-plus { border-left-color: var(--green); }
        .trans-minus { border-left-color: var(--red); }
        
        .warranty-item { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 4px solid var(--green); position: relative; }
        .warranty-item.expired { border-left: 4px solid var(--gray); opacity: 0.6; }
        .item-dates { font-size: 10px; color: var(--gray); margin-top: 5px; display: flex; justify-content: space-between; }

        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        .admin-section { display: none; }
        .admin-section.active { display: block; animation: fadeIn 0.3s; }
        .list-item-row { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; display:flex; justify-content:space-between; align-items:center; font-size: 13px;}
        .btn-icon { background: #444; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 5px; margin-left: 5px; cursor: pointer; }
        .btn-red { background: #ff453a; }

        /* Nav */
        .sidebar { position: fixed; top: 0; right: -80%; width: 70%; height: 100%; background: var(--card); z-index: 200; transition: 0.3s; padding-top: 60px; display: flex; flex-direction: column; }
        .sidebar.active { right: 0; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; }
        .sidebar-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; gap: 15px; align-items: center; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: gray; transition: 0.2s; cursor: pointer; width: 25%; }
        .nav-item.active { color: var(--red); }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 350px; }
    </style>
</head>
<body>
    <div id="seasonal-container"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ -->

    <header>
        <div class="brand">RakStore</div>
        <div class="burger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    </header>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-item" onclick="toggleSidebar()"><i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å</div>
        <div class="sidebar-item" onclick="navTo('home')"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="sidebar-item" onclick="navTo('bonuses')"><i class="fas fa-gift"></i> –ë–æ–Ω—É—Å—ã</div>
        <div class="sidebar-item" onclick="navTo('admin')"><i class="fas fa-user-shield" style="color: var(--red)"></i> –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</div>
    </div>

    <!-- 1. HOME -->
    <div id="home" class="page active">
        <!-- News -->
        <div id="news-block" style="background:rgba(255,59,48,0.1); padding:15px; border-radius:15px; margin-bottom:20px; display:none; border:1px solid var(--red);">
            <div style="font-weight:bold; color:var(--red); margin-bottom:5px;">üì¢ –ù–æ–≤–æ—Å—Ç–∏</div>
            <div id="news-text" style="font-size:13px;"></div>
        </div>

        <div class="level-card">
            <div>–í–ê–® –£–†–û–í–ï–ù–¨: <span id="lvl-display">1</span></div>
            <div style="font-size:40px; font-weight:bold; margin:10px 0;" id="discount-display">5%</div>
            <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px;">
                <span id="rub-current">0‚ÇΩ</span> <span id="rub-next">100k‚ÇΩ</span>
            </div>
        </div>

        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div style="display:flex; gap:10px;">
            <div style="background:var(--card); padding:15px; border-radius:15px; flex:1; text-align:center;">
                <div id="stat-count" style="font-size:20px; font-weight:bold; color:var(--red)">0</div>
                <div style="font-size:12px; color:gray">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div style="background:var(--card); padding:15px; border-radius:15px; flex:1; text-align:center;">
                <div id="stat-spent" style="font-size:20px; font-weight:bold; color:var(--red)">0‚ÇΩ</div>
                <div style="font-size:12px; color:gray">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
            </div>
        </div>
    </div>

    <!-- 2. BONUSES (Promos & Balance) -->
    <div id="bonuses" class="page">
        <h2>–ë–æ–Ω—É—Å—ã</h2>
        
        <div class="bonus-card">
            <div>
                <div style="font-size:12px; color:gray;">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div style="font-size:10px; color:gray;">(–ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å)</div>
            </div>
            <div class="bonus-val"><span id="bonus-balance">0</span> B</div>
        </div>

        <div style="background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <h4 style="margin-top:0"><i class="fas fa-ticket-alt"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="user-promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" style="margin:0;">
                <button onclick="activatePromo()" style="width:auto; padding:0 20px;">OK</button>
            </div>
            <p style="font-size:10px; color:gray; margin-top:5px;">–ë–æ–Ω—É—Å—ã –º–æ–∂–Ω–æ –∫–æ–ø–∏—Ç—å –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫.</p>
        </div>

        <div style="background: var(--card); padding: 15px; border-radius: 15px;">
            <h4 style="margin-top:0"><i class="fas fa-users"></i> –†–µ—Ñ–µ—Ä–∞–ª—ã</h4>
            <p style="font-size:12px;">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞: —Ç–≤–æ–π ID <b id="my-ref-id" style="color:var(--green)">...</b></p>
            <div id="ref-input-area" style="display:flex; gap:10px; margin-top:10px;">
                <input type="number" id="referrer-input" placeholder="ID –¥—Ä—É–≥–∞" style="margin:0;">
                <button onclick="setReferrer()" style="width:auto; padding:0 15px;">OK</button>
            </div>
            <p id="ref-status" style="color:var(--green); font-size:12px; display:none; margin-top:5px;">–í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã: <span id="ref-who"></span></p>
        </div>
    </div>

    <!-- 3. TRANSACTIONS & HISTORY -->
    <div id="history" class="page">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>
        <div id="history-items-list"></div>
        
        <h3 style="margin-top:30px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
        <p style="font-size:10px; color:gray;">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –∏ —Å–ø–∏—Å–∞–Ω–∏–π</p>
        <div id="history-trans-list"></div>
    </div>
    
    <!-- 4. ADMIN -->
    <div id="admin" class="page">
        <h2 style="color: var(--red)">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        
        <div id="admin-login">
            <input type="password" id="adm-password-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="admin-controls" style="display:none;">
            <!-- Tabs -->
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="switchAdminTab('adm-tab-users', this)">–Æ–∑–µ—Ä—ã</div>
                <div class="admin-tab" onclick="switchAdminTab('adm-tab-promos', this)">–ü—Ä–æ–º–æ</div>
                <div class="admin-tab" onclick="switchAdminTab('adm-tab-theme', this)">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
            </div>

            <!-- TAB: USERS -->
            <div id="adm-tab-users" class="admin-section active">
                <label>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@username):</label>
                <input type="text" id="adm-search-user">
                <button onclick="adminFindUser()" style="background:#333; margin-bottom:15px;">–ù–∞–π—Ç–∏</button>
                
                <!-- Issue Form -->
                <div id="issue-form" style="display:none; border-top:1px solid #333; padding-top:15px;">
                    <h4>–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä: <span id="issue-target-name" style="color:var(--red)"></span></h4>
                    <input type="text" id="adm-issue-item" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                    <input type="number" id="adm-issue-price" placeholder="–¶–µ–Ω–∞ (–≤–ª–∏—è–µ—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å)">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="adm-issue-dur" placeholder="–°—Ä–æ–∫">
                        <select id="adm-issue-unit">
                            <option value="hours">–ß–∞—Å–æ–≤</option>
                            <option value="days" selected>–î–Ω–µ–π</option>
                            <option value="months">–ú–µ—Å—è—Ü–µ–≤</option>
                            <option value="years">–õ–µ—Ç</option>
                        </select>
                    </div>
                    <button onclick="adminGiveItem()">–í—ã–¥–∞—Ç—å</button>
                </div>
                <div id="adm-user-items-list" style="margin-top:15px;"></div>
            </div>

            <!-- TAB: PROMOS -->
            <div id="adm-tab-promos" class="admin-section">
                <h4>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h4>
                <input type="text" id="promo-code" placeholder="–ö–æ–¥ (BONUS2026)">
                <input type="number" id="promo-val" placeholder="–°—É–º–º–∞ –ë–æ–Ω—É—Å–æ–≤">
                <input type="number" id="promo-hours" placeholder="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (—á–∞—Å–æ–≤)">
                <button onclick="adminCreatePromo()">–°–æ–∑–¥–∞—Ç—å</button>
                <div id="adm-promos-list" style="margin-top:15px;"></div>
            </div>
            
            <!-- TAB: THEME (SEASONS) -->
            <div id="adm-tab-theme" class="admin-section">
                <h4>–†–µ–∂–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="setTheme('default')" style="background:#333">–°—Ç–∞–Ω–¥–∞—Ä—Ç</button>
                    <button onclick="setTheme('halloween')" style="background:#d35400">üéÉ –•—ç–ª–ª–æ—É–∏–Ω</button>
                    <button onclick="setTheme('newyear')" style="background:#3498db">‚ùÑÔ∏è –ù–æ–≤—ã–π –ì–æ–¥</button>
                    <button onclick="setTheme('autumn')" style="background:#e67e22">üçÇ –û—Å–µ–Ω—å</button>
                    <button onclick="setTheme('summer')" style="background:#f1c40f; color:black;">‚òÄÔ∏è –õ–µ—Ç–æ</button>
                    <button onclick="setTheme('spring')" style="background:#ff69b4">üå∏ –í–µ—Å–Ω–∞</button>
                </div>
                <h4 style="margin-top:20px;">–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</h4>
                <input type="text" id="adm-news-text" placeholder="–¢–µ–∫—Å—Ç...">
                <button onclick="adminSetNews()" style="background:#333">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT ITEM -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="edit-user-id"><input type="hidden" id="edit-item-id"><input type="hidden" id="edit-old-price">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" id="edit-name">
            <label>–¶–µ–Ω–∞:</label><input type="number" id="edit-price">
            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label><input type="datetime-local" id="edit-date">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="saveEditedItem()" style="background:var(--green)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="closeModal()" style="background:#444">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-item" onclick="navTo('bonuses')"><i class="fas fa-gift"></i> –ë–æ–Ω—É—Å—ã</div>
        <div class="nav-item" onclick="navTo('history')"><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
    </nav>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment, collection, query, where, getDocs, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // === CONFIG ===
        const MY_ADMIN_PASSWORD = "5815";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDFrEbOwmtZlWlrPhImDlA0PE1tQKvYNAY",
            authDomain: "rakstore-a80a8.firebaseapp.com",
            projectId: "rakstore-a80a8",
            storageBucket: "rakstore-a80a8.firebasestorage.app",
            messagingSenderId: "55025016203",
            appId: "1:55025016203:web:8a6b67666dbb3df285238e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myUserId = tg.initDataUnsafe?.user?.id || 11111;
        let myUsername = tg.initDataUnsafe?.user?.username || "unknown";
        if(myUsername) myUsername = myUsername.toLowerCase();
        
        // === CORE ===

        async function init() {
            // 1. Load Theme
            const settingsSnap = await getDoc(doc(db, "settings", "general"));
            if(settingsSnap.exists()) {
                const s = settingsSnap.data();
                if(s.theme) applyThemeLocal(s.theme);
                if(s.news) {
                    document.getElementById('news-block').style.display = 'block';
                    document.getElementById('news-text').innerText = s.news;
                }
            }

            // 2. Load User
            const userRef = doc(db, "users", myUserId.toString());
            const snap = await getDoc(userRef);
            if(snap.exists()) {
                if(snap.data().username !== myUsername) updateDoc(userRef, { username: myUsername });
                renderUI(snap.data());
            } else {
                const newUser = { 
                    username: myUsername, name: tg.initDataUnsafe?.user?.first_name || "Guest",
                    spent: 0, items: [], bonusBalance: 0, transactions: []
                };
                await setDoc(userRef, newUser);
                renderUI(newUser);
            }
            document.getElementById('my-ref-id').innerText = myUserId;
        }

        function renderUI(data) {
            // Level (xp = spent money on items)
            const RUB_PER_LEVEL = 100000;
            let spent = data.spent || 0;
            let level = Math.floor(spent / RUB_PER_LEVEL) + 1;
            let percent = (spent % RUB_PER_LEVEL) / RUB_PER_LEVEL * 100;
            
            document.getElementById('lvl-display').innerText = level;
            document.getElementById('discount-display').innerText = (level * 5) + "%";
            document.getElementById('xp-fill').style.width = percent + "%";
            document.getElementById('rub-current').innerText = (spent % RUB_PER_LEVEL).toLocaleString() + "‚ÇΩ";
            document.getElementById('stat-spent').innerText = spent.toLocaleString() + "‚ÇΩ";

            // Bonuses
            document.getElementById('bonus-balance').innerText = data.bonusBalance || 0;
            if(data.referrerId) {
                document.getElementById('ref-input-area').style.display = 'none';
                document.getElementById('ref-status').style.display = 'block';
                document.getElementById('ref-who').innerText = data.referrerId;
            }

            // History Items
            const listItems = document.getElementById('history-items-list');
            listItems.innerHTML = "";
            let activeCount = 0;
            if(data.items && data.items.length) {
                const sorted = [...data.items].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(item => {
                    const expire = new Date(item.expiryDate);
                    const isExpired = new Date() > expire;
                    if(!isExpired) activeCount++;
                    listItems.innerHTML += `
                    <div class="warranty-item ${isExpired ? 'expired' : ''}">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${item.name}</span> <span>${item.price}‚ÇΩ</span>
                        </div>
                        <div class="item-dates">
                            <span>–í—ã–¥–∞–Ω–∞: ${new Date(item.date).toLocaleDateString()}</span>
                            <span>–î–æ: ${expire.toLocaleDateString()} ${expire.getHours()}:00</span>
                        </div>
                    </div>`;
                });
            } else listItems.innerHTML = "<p style='text-align:center;color:gray'>–ü—É—Å—Ç–æ</p>";
            document.getElementById('stat-count').innerText = activeCount;

            // Transactions
            const listTrans = document.getElementById('history-trans-list');
            listTrans.innerHTML = "";
            if(data.transactions && data.transactions.length) {
                // Reverse to show newest first
                [...data.transactions].reverse().forEach(t => {
                    const sign = t.amount > 0 ? '+' : '';
                    const css = t.amount > 0 ? 'trans-plus' : 'trans-minus';
                    listTrans.innerHTML += `
                    <div class="trans-item ${css}">
                        <div>${t.reason}</div>
                        <div style="font-weight:bold;">${sign}${t.amount}</div>
                    </div>`;
                });
            } else listTrans.innerHTML = "<p style='text-align:center;color:gray'>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>";
        }

        // === THEME ENGINE ===
        window.setTheme = async (mode) => {
            await setDoc(doc(db, "settings", "general"), { theme: mode }, { merge: true });
            alert("–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è).");
            applyThemeLocal(mode);
        }

        function applyThemeLocal(mode) {
            document.body.className = `mode-${mode}`;
            const c = document.getElementById('seasonal-container');
            c.innerHTML = ""; // clear old
            
            if(mode === 'newyear') {
                for(let i=0; i<30; i++) {
                    const el = document.createElement('div');
                    el.className = 'snow-flake';
                    el.innerHTML = '‚ùÑ';
                    el.style.left = Math.random()*100 + 'vw';
                    el.style.animationDuration = (Math.random()*5 + 5) + 's';
                    el.style.fontSize = (Math.random()*10 + 10) + 'px';
                    c.appendChild(el);
                }
            } else if(mode === 'halloween') {
                const el = document.createElement('div');
                el.className = 'ghost';
                el.innerHTML = 'üëª';
                c.appendChild(el);
            } else if(mode === 'autumn') {
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'leaf';
                    el.innerHTML = 'üçÇ';
                    el.style.left = Math.random()*100 + 'vw';
                    el.style.animationDuration = (Math.random()*5 + 5) + 's';
                    c.appendChild(el);
                }
            } else if(mode === 'summer') {
                const el = document.createElement('div');
                el.className = 'sun-flare';
                c.appendChild(el);
            } else if(mode === 'spring') {
                for(let i=0; i<20; i++) {
                    const el = document.createElement('div');
                    el.className = 'flower';
                    el.innerHTML = 'üå∏';
                    el.style.left = Math.random()*100 + 'vw';
                    el.style.animationDuration = (Math.random()*8 + 4) + 's';
                    c.appendChild(el);
                }
            }
        }

        // === USER ACTIONS ===
        window.activatePromo = async () => {
            const code = document.getElementById('user-promo-input').value.trim().toUpperCase();
            if(!code) return;
            const ref = doc(db, "promocodes", code);
            const snap = await getDoc(ref);
            if(!snap.exists()) return alert("–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
            const p = snap.data();
            if(new Date() > new Date(p.expiresAt)) return alert("–ò—Å—Ç–µ–∫");
            if(p.users && p.users.includes(myUserId.toString())) return alert("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω");

            // Add Bonus + Transaction
            const trans = { amount: p.value, reason: `–ü—Ä–æ–º–æ–∫–æ–¥ ${code}`, date: new Date().toISOString() };
            
            await updateDoc(ref, { users: arrayUnion(myUserId.toString()) });
            await updateDoc(doc(db, "users", myUserId.toString()), { 
                bonusBalance: increment(p.value),
                transactions: arrayUnion(trans)
            });
            alert("–ë–æ–Ω—É—Å—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!");
            location.reload();
        }

        window.setReferrer = async () => {
            const id = document.getElementById('referrer-input').value;
            if(id == myUserId) return alert("–ù–µ–ª—å–∑—è —Å–µ–±—è");
            const check = await getDoc(doc(db, "users", id.toString()));
            if(!check.exists()) return alert("–ù–µ—Ç —Ç–∞–∫–æ–≥–æ ID");
            await updateDoc(doc(db, "users", myUserId.toString()), { referrerId: id.toString() });
            alert("–û–ö");
            location.reload();
        }

        // === ADMIN ACTIONS ===
        window.adminLogin = () => {
            if(document.getElementById('adm-password-input').value === MY_ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-controls').style.display = 'block';
                loadAdminPromos();
            } else alert("Error");
        }

        window.switchAdminTab = (id, el) => {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        // Users
        let foundUserId = null;
        window.adminFindUser = async () => {
            const uname = document.getElementById('adm-search-user').value.trim().toLowerCase().replace("@","");
            const q = query(collection(db, "users"), where("username", "==", uname));
            const snap = await getDocs(q);
            const list = document.getElementById('adm-user-items-list');
            
            if(snap.empty) { list.innerHTML="–ù–µ—Ç"; document.getElementById('issue-form').style.display='none'; return; }

            const u = snap.docs[0].data();
            foundUserId = snap.docs[0].id;
            document.getElementById('issue-form').style.display='block';
            document.getElementById('issue-target-name').innerText = "@"+u.username;
            
            list.innerHTML = "";
            if(u.items) {
                u.items.forEach(i => {
                    list.innerHTML += `
                    <div class="list-item-row">
                        <div><b>${i.name}</b> (${i.price}‚ÇΩ)</div>
                        <div style="display:flex">
                            <div class="btn-icon" onclick="openEditModal('${foundUserId}','${i.id}')"><i class="fas fa-pen"></i></div>
                            <div class="btn-icon btn-red" onclick="admDelItem('${foundUserId}','${i.id}',${i.price})"><i class="fas fa-trash"></i></div>
                        </div>
                    </div>`;
                });
            }
        }

        window.adminGiveItem = async () => {
            if(!foundUserId) return;
            const name = document.getElementById('adm-issue-item').value;
            const price = Number(document.getElementById('adm-issue-price').value);
            const dur = Number(document.getElementById('adm-issue-dur').value);
            const unit = document.getElementById('adm-issue-unit').value;

            let d = new Date();
            if(unit==='hours') d.setHours(d.getHours()+dur);
            if(unit==='days') d.setDate(d.getDate()+dur);
            if(unit==='months') d.setMonth(d.getMonth()+dur);
            if(unit==='years') d.setFullYear(d.getFullYear()+dur);

            const newItem = { id: Date.now().toString(), name, price, date: new Date().toISOString(), expiryDate: d.toISOString() };
            // Log Transaction
            const trans = { amount: price, reason: `–ü–æ–∫—É–ø–∫–∞: ${name}`, date: new Date().toISOString() }; // Not affecting balance here, just logging price as value of purchase

            await updateDoc(doc(db, "users", foundUserId), {
                items: arrayUnion(newItem),
                spent: increment(price),
                transactions: arrayUnion(trans)
            });
            alert("–í—ã–¥–∞–Ω–æ");
            adminFindUser();
        }

        // Promos
        window.loadAdminPromos = async () => {
            const d = document.getElementById('adm-promos-list');
            d.innerHTML = "";
            const s = await getDocs(collection(db, "promocodes"));
            s.forEach(doc => {
                 d.innerHTML += `<div class="list-item-row"><span>${doc.id} (${doc.data().value}B)</span><div class="btn-icon btn-red" onclick="admDelPromo('${doc.id}')"><i class="fas fa-trash"></i></div></div>`;
            });
        }
        window.adminCreatePromo = async () => {
            const c = document.getElementById('promo-code').value.toUpperCase();
            const v = Number(document.getElementById('promo-val').value);
            const h = Number(document.getElementById('promo-hours').value);
            let exp = new Date(); exp.setHours(exp.getHours()+h);
            await setDoc(doc(db, "promocodes", c), { value: v, expiresAt: exp.toISOString(), users: [] });
            loadAdminPromos();
        }
        window.admDelPromo = async (id) => { if(confirm("Del?")) { await deleteDoc(doc(db,"promocodes",id)); loadAdminPromos(); }}
        
        window.adminSetNews = async () => {
            const t = document.getElementById('adm-news-text').value;
            await setDoc(doc(db,"settings","general"),{news: t}, {merge:true});
            alert("Saved");
        }

        // Edit/Delete Item
        window.openEditModal = async (uid, iid) => {
            const s = await getDoc(doc(db, "users", uid));
            const i = s.data().items.find(x => x.id === iid);
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-item-id').value = iid;
            document.getElementById('edit-old-price').value = i.price;
            document.getElementById('edit-name').value = i.name;
            document.getElementById('edit-price').value = i.price;
            const dt = new Date(i.expiryDate);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            document.getElementById('edit-date').value = dt.toISOString().slice(0,16);
            document.getElementById('edit-modal').style.display = 'flex';
        }
        window.saveEditedItem = async () => {
            const uid = document.getElementById('edit-user-id').value;
            const iid = document.getElementById('edit-item-id').value;
            const np = Number(document.getElementById('edit-price').value);
            const op = Number(document.getElementById('edit-old-price').value);
            const nn = document.getElementById('edit-name').value;
            const nd = new Date(document.getElementById('edit-date').value).toISOString();
            
            const r = doc(db, "users", uid);
            const s = await getDoc(r);
            let it = s.data().items;
            const idx = it.findIndex(x => x.id === iid);
            if(idx > -1) {
                it[idx].name = nn; it[idx].price = np; it[idx].expiryDate = nd;
                await updateDoc(r, { items: it, spent: increment(np - op) });
                alert("Saved"); document.getElementById('edit-modal').style.display='none'; adminFindUser();
            }
        }
        window.closeModal = () => document.getElementById('edit-modal').style.display='none';
        window.admDelItem = async (uid, iid, p) => {
            if(confirm("Del?")) {
                const r = doc(db, "users", uid);
                const s = await getDoc(r);
                const it = s.data().items.filter(x => x.id !== iid);
                // Add transaction record about deletion (refund)
                const trans = { amount: -p, reason: "–í–æ–∑–≤—Ä–∞—Ç/–£–¥–∞–ª–µ–Ω–∏–µ", date: new Date().toISOString() };
                await updateDoc(r, { items: it, spent: increment(-p), transactions: arrayUnion(trans) });
                adminFindUser();
            }
        }

        // Navigation
        window.navTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => {
                if(e.getAttribute('onclick').includes(id)) e.classList.add('active'); else e.classList.remove('active');
            });
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').style.display='none';
        }
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('active');
            document.querySelector('.sidebar-overlay').style.display = sb.classList.contains('active')?'block':'none';
        }

        init();
    </script>
</body>
</html>
