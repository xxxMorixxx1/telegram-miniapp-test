<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RakStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --red: #ff3b30; --green: #30d158; --gray: #8e8e93; --gold: #ffd700; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; transition: background 0.5s; }
        
        /* SEASONAL EFFECTS */
        #seasonal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: hidden; }
        
        /* Snow */
        .snow-flake { position: absolute; color: white; top: -20px; animation: fall linear infinite; opacity: 0.8; }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* Halloween */
        body.mode-halloween { background: #240a00; --red: #ff6600; }
        .ghost { position: absolute; font-size: 30px; opacity: 0.3; animation: floatGhost 15s linear infinite; }
        @keyframes floatGhost { 0% { transform: translate(-10vw, 110vh); } 100% { transform: translate(110vw, -10vh); } }

        /* Autumn */
        body.mode-autumn { background: #1a1000; --green: #d48806; }
        .leaf { position: absolute; color: #d48806; animation: fallRotate 8s linear infinite; font-size: 20px; }
        @keyframes fallRotate { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }

        /* Summer */
        body.mode-summer { background: #001a1a; --red: #ffcc00; }
        .sun-flare { position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,204,0,0.3) 0%, rgba(0,0,0,0) 70%); }

        /* Spring */
        body.mode-spring { background: #0f1a15; --red: #ff69b4; }
        .flower { position: absolute; color: #ff69b4; animation: fall 10s linear infinite; font-size: 14px; }

        /* UI */
        header { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--card); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 24px; font-weight: 900; color: var(--red); text-transform: uppercase; }
        .burger { font-size: 24px; cursor: pointer; }
        
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .admin-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .admin-tab { background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .admin-tab.active { background: var(--red); color: white; }

        .level-card { background: linear-gradient(135deg, var(--red), #ff9f0a); padding: 20px; border-radius: 20px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); }
        .xp-bar-bg { background: rgba(0,0,0,0.2); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .xp-bar-fill { background: white; height: 100%; width: 0%; transition: 1s; }

        .bonus-card { background: #333; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--gold); }
        .bonus-val { color: var(--gold); font-size: 24px; font-weight: bold; }

        .trans-item { background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; font-size: 12px; border-left: 3px solid #555; }
        .trans-plus { border-left-color: var(--green); }
        .trans-minus { border-left-color: var(--red); }
        
        .warranty-item { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 4px solid var(--green); position: relative; }
        .warranty-item.expired { border-left: 4px solid var(--gray); opacity: 0.6; }
        .item-dates { font-size: 10px; color: var(--gray); margin-top: 5px; display: flex; justify-content: space-between; }

        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        .admin-section { display: none; }
        .admin-section.active { display: block; animation: fadeIn 0.3s; }
        .list-item-row { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; display:flex; justify-content:space-between; align-items:center; font-size: 13px;}
        .btn-icon { background: #444; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 5px; margin-left: 5px; cursor: pointer; }
        .btn-red { background: #ff453a; }

        .sidebar { position: fixed; top: 0; right: -80%; width: 70%; height: 100%; background: var(--card); z-index: 200; transition: 0.3s; padding-top: 60px; display: flex; flex-direction: column; }
        .sidebar.active { right: 0; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; }
        .sidebar-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; display: flex; gap: 15px; align-items: center; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: gray; transition: 0.2s; cursor: pointer; width: 33%; }
        .nav-item.active { color: var(--red); }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 350px; }
        
        #error-screen { position: fixed; inset:0; background: #000; color: red; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; display: none; }
    </style>
</head>
<body>
    <div id="error-screen"></div>
    <div id="seasonal-container"></div>

    <header>
        <div class="brand">RakStore</div>
        <div class="burger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    </header>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-item" onclick="toggleSidebar()"><i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å</div>
        <div class="sidebar-item" onclick="navTo('home')"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="sidebar-item" onclick="navTo('bonuses')"><i class="fas fa-gift"></i> –ë–æ–Ω—É—Å—ã</div>
        <div class="sidebar-item" onclick="navTo('admin')"><i class="fas fa-user-shield" style="color: var(--red)"></i> –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</div>
    </div>

    <!-- 1. HOME -->
    <div id="home" class="page active">
        <div id="news-block" style="background:rgba(255,59,48,0.1); padding:15px; border-radius:15px; margin-bottom:20px; display:none; border:1px solid var(--red);">
            <div style="font-weight:bold; color:var(--red); margin-bottom:5px;">üì¢ –ù–æ–≤–æ—Å—Ç–∏</div>
            <div id="news-text" style="font-size:13px;"></div>
        </div>

        <div class="level-card">
            <div>–í–ê–® –£–†–û–í–ï–ù–¨: <span id="lvl-display">1</span></div>
            <div style="font-size:40px; font-weight:bold; margin:10px 0;" id="discount-display">5%</div>
            <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px;">
                <span id="rub-current">0‚ÇΩ</span> <span id="rub-next">100k‚ÇΩ</span>
            </div>
        </div>

        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div style="display:flex; gap:10px;">
            <div style="background:var(--card); padding:15px; border-radius:15px; flex:1; text-align:center;">
                <div id="stat-count" style="font-size:20px; font-weight:bold; color:var(--red)">0</div>
                <div style="font-size:12px; color:gray">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div style="background:var(--card); padding:15px; border-radius:15px; flex:1; text-align:center;">
                <div id="stat-spent" style="font-size:20px; font-weight:bold; color:var(--red)">0‚ÇΩ</div>
                <div style="font-size:12px; color:gray">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
            </div>
        </div>
    </div>

    <!-- 2. BONUSES -->
    <div id="bonuses" class="page">
        <h2>–ë–æ–Ω—É—Å—ã</h2>
        <div class="bonus-card">
            <div>
                <div style="font-size:12px; color:gray;">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div style="font-size:10px; color:gray;">(–ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å)</div>
            </div>
            <div class="bonus-val"><span id="bonus-balance">0</span> B</div>
        </div>

        <div style="background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <h4 style="margin-top:0"><i class="fas fa-ticket-alt"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="user-promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" style="margin:0;">
                <button onclick="activatePromo()" style="width:auto; padding:0 20px;">OK</button>
            </div>
        </div>

        <div style="background: var(--card); padding: 15px; border-radius: 15px;">
            <h4 style="margin-top:0"><i class="fas fa-users"></i> –†–µ—Ñ–µ—Ä–∞–ª—ã</h4>
            <p style="font-size:12px;">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞: —Ç–≤–æ–π ID <b id="my-ref-id" style="color:var(--green)">...</b></p>
            <div id="ref-input-area" style="display:flex; gap:10px; margin-top:10px;">
                <input type="number" id="referrer-input" placeholder="ID –¥—Ä—É–≥–∞" style="margin:0;">
                <button onclick="setReferrer()" style="width:auto; padding:0 15px;">OK</button>
            </div>
            <p id="ref-status" style="color:var(--green); font-size:12px; display:none; margin-top:5px;">–í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã: <span id="ref-who"></span></p>
        </div>
    </div>

    <!-- 3. HISTORY -->
    <div id="history" class="page">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>
        <div id="history-items-list"></div>
        <h3 style="margin-top:30px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
        <div id="history-trans-list"></div>
    </div>
    
    <!-- 4. ADMIN -->
    <div id="admin" class="page">
        <h2 style="color: var(--red)">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <div id="admin-login">
            <input type="password" id="adm-password-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="admin-controls" style="display:none;">
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="switchAdminTab('adm-tab-users', this)">–Æ–∑–µ—Ä—ã</div>
                <div class="admin-tab" onclick="switchAdminTab('adm-tab-promos', this)">–ü—Ä–æ–º–æ</div>
                <div class="admin-tab" onclick="switchAdminTab('adm-tab-theme', this)">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
            </div>

            <!-- USERS -->
            <div id="adm-tab-users" class="admin-section active">
                <label>–ü–æ–∏—Å–∫ (@username):</label>
                <input type="text" id="adm-search-user">
                <button onclick="adminFindUser()" style="background:#333; margin-bottom:15px;">–ù–∞–π—Ç–∏</button>
                
                <div id="issue-form" style="display:none; border-top:1px solid #333; padding-top:15px;">
                    <h4>–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä: <span id="issue-target-name" style="color:var(--red)"></span></h4>
                    <input type="text" id="adm-issue-item" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                    <input type="number" id="adm-issue-price" placeholder="–¶–µ–Ω–∞">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="adm-issue-dur" placeholder="–°—Ä–æ–∫">
                        <select id="adm-issue-unit">
                            <option value="days">–î–Ω–µ–π</option>
                            <option value="hours">–ß–∞—Å–æ–≤</option>
                            <option value="months">–ú–µ—Å—è—Ü–µ–≤</option>
                            <option value="years">–õ–µ—Ç</option>
                        </select>
                    </div>
                    <button onclick="adminGiveItem()">–í—ã–¥–∞—Ç—å</button>
                </div>
                <div id="adm-user-items-list" style="margin-top:15px;"></div>
            </div>

            <!-- PROMOS -->
            <div id="adm-tab-promos" class="admin-section">
                <h4>–°–æ–∑–¥–∞—Ç—å –∫–æ–¥</h4>
                <input type="text" id="promo-code" placeholder="–ö–æ–¥">
                <input type="number" id="promo-val" placeholder="–°—É–º–º–∞">
                <input type="number" id="promo-hours" placeholder="–ß–∞—Å–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è">
                <button onclick="adminCreatePromo()">–°–æ–∑–¥–∞—Ç—å</button>
                <div id="adm-promos-list" style="margin-top:15px;"></div>
            </div>
            
            <!-- THEME -->
            <div id="adm-tab-theme" class="admin-section">
                <h4>–†–µ–∂–∏–º</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="setTheme('default')" style="background:#333">–°—Ç–∞–Ω–¥–∞—Ä—Ç</button>
                    <button onclick="setTheme('halloween')" style="background:#d35400">üéÉ –•—ç–ª–ª–æ—É–∏–Ω</button>
                    <button onclick="setTheme('newyear')" style="background:#3498db">‚ùÑÔ∏è –ù–æ–≤—ã–π –ì–æ–¥</button>
                    <button onclick="setTheme('autumn')" style="background:#e67e22">üçÇ –û—Å–µ–Ω—å</button>
                    <button onclick="setTheme('summer')" style="background:#f1c40f; color:black;">‚òÄÔ∏è –õ–µ—Ç–æ</button>
                    <button onclick="setTheme('spring')" style="background:#ff69b4">üå∏ –í–µ—Å–Ω–∞</button>
                </div>
                <h4 style="margin-top:20px;">–ù–æ–≤–æ—Å—Ç–∏</h4>
                <input type="text" id="adm-news-text">
                <button onclick="adminSetNews()" style="background:#333">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="edit-user-id"><input type="hidden" id="edit-item-id"><input type="hidden" id="edit-old-price">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" id="edit-name">
            <label>–¶–µ–Ω–∞:</label><input type="number" id="edit-price">
            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label><input type="datetime-local" id="edit-date">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="saveEditedItem()" style="background:var(--green)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="closeModal()" style="background:#444">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-item" onclick="navTo('bonuses')"><i class="fas fa-gift"></i> –ë–æ–Ω—É—Å—ã</div>
        <div class="nav-item" onclick="navTo('history')"><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment, collection, query, where, getDocs, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        //  –¢–í–û–ò –î–ê–ù–ù–´–ï (–í–°–¢–ê–í–õ–ï–ù–´)
        // ==========================================
        const MY_ADMIN_PASSWORD = "123"; // –ù–µ –∑–∞–±—É–¥—å —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ!

        const firebaseConfig = {
             apiKey: "AIzaSyDFrEbOwmtZlWlrPhImDlA0PE1tQKvYNAY",
             authDomain: "rakstore-a80a8.firebaseapp.com",
             projectId: "rakstore-a80a8",
             storageBucket: "rakstore-a80a8.firebasestorage.app",
             messagingSenderId: "55025016203",
             appId: "1:55025016203:web:8a6b67666dbb3df285238e"
        };
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myUserId = tg.initDataUnsafe?.user?.id || 11111;
        let myUsername = tg.initDataUnsafe?.user?.username || "unknown";
        if(myUsername) myUsername = myUsername.toLowerCase();
        
        async function init() {
            try {
                // Theme
                const setRef = doc(db, "settings", "general");
                const sSnap = await getDoc(setRef);
                if(sSnap.exists()) {
                    const d = sSnap.data();
                    if(d.theme) applyTheme(d.theme);
                    if(d.news) {
                        document.getElementById('news-block').style.display = 'block';
                        document.getElementById('news-text').innerText = d.news;
                    }
                }

                // User
                const userRef = doc(db, "users", myUserId.toString());
                const uSnap = await getDoc(userRef);
                if(uSnap.exists()) {
                    if(uSnap.data().username !== myUsername) updateDoc(userRef, { username: myUsername });
                    renderUI(uSnap.data());
                } else {
                    const newUser = { username: myUsername, spent: 0, items: [], bonusBalance: 0, transactions: [] };
                    await setDoc(userRef, newUser);
                    renderUI(newUser);
                }
                document.getElementById('my-ref-id').innerText = myUserId;

            } catch(e) { 
                console.error(e);
                document.getElementById('error-screen').style.display = 'flex';
                document.getElementById('error-screen').innerHTML = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.";
            }
        }

        function renderUI(data) {
            const RUB_PER_LEVEL = 100000;
            let spent = data.spent || 0;
            let level = Math.floor(spent / RUB_PER_LEVEL) + 1;
            let percent = (spent % RUB_PER_LEVEL) / RUB_PER_LEVEL * 100;
            
            document.getElementById('lvl-display').innerText = level;
            document.getElementById('discount-display').innerText = (level * 5) + "%";
            document.getElementById('xp-fill').style.width = percent + "%";
            document.getElementById('rub-current').innerText = (spent % RUB_PER_LEVEL).toLocaleString() + "‚ÇΩ";
            document.getElementById('stat-spent').innerText = spent.toLocaleString() + "‚ÇΩ";

            document.getElementById('bonus-balance').innerText = data.bonusBalance || 0;
            if(data.referrerId) {
                document.getElementById('ref-input-area').style.display = 'none';
                document.getElementById('ref-status').style.display = 'block';
                document.getElementById('ref-who').innerText = data.referrerId;
            }

            // History
            const listI = document.getElementById('history-items-list');
            listI.innerHTML = "";
            let active = 0;
            if(data.items) {
                [...data.items].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(i => {
                    const exp = new Date(i.expiryDate);
                    const isExp = new Date() > exp;
                    if(!isExp) active++;
                    listI.innerHTML += `<div class="warranty-item ${isExp?'expired':''}">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${i.name}</span><span>${i.price}‚ÇΩ</span></div>
                        <div class="item-dates"><span>–í—ã–¥–∞–Ω–∞: ${new Date(i.date).toLocaleDateString()}</span><span>–î–æ: ${exp.toLocaleDateString()} ${exp.getHours()}:00</span></div>
                    </div>`;
                });
            }
            document.getElementById('stat-count').innerText = active;

            // Transactions
            const listT = document.getElementById('history-trans-list');
            listT.innerHTML = "";
            if(data.transactions) {
                [...data.transactions].reverse().forEach(t => {
                    const css = t.amount>0 ? 'trans-plus' : 'trans-minus';
                    listT.innerHTML += `<div class="trans-item ${css}"><div>${t.reason}</div><b>${t.amount>0?'+':''}${t.amount}</b></div>`;
                });
            }
        }

        // --- GLOBAL FUNCTIONS ---
        window.navTo = (id) => {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => {
                if(e.getAttribute('onclick').includes(id)) e.classList.add('active'); else e.classList.remove('active');
            });
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').style.display='none';
        }
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('active');
            document.querySelector('.sidebar-overlay').style.display=sb.classList.contains('active')?'block':'none';
        }

        // --- BONUSES ---
        window.activatePromo = async () => {
            const c = document.getElementById('user-promo-input').value.trim().toUpperCase();
            if(!c) return;
            const ref = doc(db, "promocodes", c);
            const s = await getDoc(ref);
            if(!s.exists()) return alert("–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
            const d = s.data();
            if(new Date() > new Date(d.expiresAt)) return alert("–ò—Å—Ç–µ–∫");
            if(d.users && d.users.includes(myUserId.toString())) return alert("–£–∂–µ –±—ã–ª");

            const trans = { amount: d.value, reason: `–ö–æ–¥ ${c}`, date: new Date().toISOString() };
            await updateDoc(ref, { users: arrayUnion(myUserId.toString()) });
            await updateDoc(doc(db,"users",myUserId.toString()), { 
                bonusBalance: increment(d.value), transactions: arrayUnion(trans) 
            });
            alert("–ë–æ–Ω—É—Å—ã!"); location.reload();
        }

        window.setReferrer = async () => {
            const id = document.getElementById('referrer-input').value;
            if(id == myUserId) return alert("–ù–µ–ª—å–∑—è");
            const c = await getDoc(doc(db,"users",id.toString()));
            if(!c.exists()) return alert("–ù–µ—Ç ID");
            await updateDoc(doc(db,"users",myUserId.toString()), { referrerId: id.toString() });
            alert("–û–ö"); location.reload();
        }

        // --- ADMIN ---
        window.adminLogin = () => {
            if(document.getElementById('adm-password-input').value === MY_ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-controls').style.display = 'block';
                loadPromos();
            }
        }
        window.switchAdminTab = (id, el) => {
            document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
        }

        // Theme
        window.setTheme = async (mode) => {
            await setDoc(doc(db,"settings","general"), {theme: mode}, {merge:true});
            applyTheme(mode); alert("–¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞");
        }
        window.adminSetNews = async () => {
            await setDoc(doc(db,"settings","general"), {news: document.getElementById('adm-news-text').value}, {merge:true});
            alert("–ù–æ–≤–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
        }
        function applyTheme(mode) {
            document.body.className = `mode-${mode}`;
            const c = document.getElementById('seasonal-container'); c.innerHTML = "";
            if(mode==='newyear') createParticles(c,'snow-flake','‚ùÑ',30);
            if(mode==='halloween') { const e=document.createElement('div'); e.className='ghost'; e.innerHTML='üëª'; c.appendChild(e); }
            if(mode==='autumn') createParticles(c,'leaf','üçÇ',15);
            if(mode==='summer') { const e=document.createElement('div'); e.className='sun-flare'; c.appendChild(e); }
            if(mode==='spring') createParticles(c,'flower','üå∏',20);
        }
        function createParticles(c, cls, char, num) {
            for(let i=0; i<num; i++) {
                const el=document.createElement('div'); el.className=cls; el.innerHTML=char;
                el.style.left=Math.random()*100+'vw'; el.style.animationDuration=(Math.random()*5+5)+'s';
                c.appendChild(el);
            }
        }

        // Promos
        async function loadPromos() {
            const d = document.getElementById('adm-promos-list'); d.innerHTML="";
            (await getDocs(collection(db,"promocodes"))).forEach(x => {
                d.innerHTML += `<div class="list-item-row"><span>${x.id} (${x.data().value})</span><div class="btn-icon btn-red" onclick="delPromo('${x.id}')"><i class="fas fa-trash"></i></div></div>`;
            });
        }
        window.adminCreatePromo = async () => {
            const c = document.getElementById('promo-code').value.toUpperCase();
            const v = Number(document.getElementById('promo-val').value);
            const h = Number(document.getElementById('promo-hours').value);
            let e = new Date(); e.setHours(e.getHours()+h);
            await setDoc(doc(db,"promocodes",c), {value:v, expiresAt:e.toISOString(), users:[]});
            loadPromos();
        }
        window.delPromo = async (id) => { if(confirm("Del?")) { await deleteDoc(doc(db,"promocodes",id)); loadPromos(); }};

        // Users
        let fUid = null;
        window.adminFindUser = async () => {
            const n = document.getElementById('adm-search-user').value.toLowerCase().trim().replace("@","");
            const q = query(collection(db,"users"), where("username","==",n));
            const s = await getDocs(q);
            const l = document.getElementById('adm-user-items-list'); l.innerHTML="";
            if(s.empty) { document.getElementById('issue-form').style.display='none'; l.innerHTML="–ù–µ—Ç"; return; }
            
            const u = s.docs[0].data(); fUid = s.docs[0].id;
            document.getElementById('issue-form').style.display='block';
            document.getElementById('issue-target-name').innerText = "@"+u.username;
            if(u.items) {
                u.items.forEach(i => {
                    l.innerHTML += `<div class="list-item-row">
                    <div><b>${i.name}</b> (${i.price}‚ÇΩ)</div>
                    <div style="display:flex"><div class="btn-icon" onclick="openEdit('${fUid}','${i.id}')"><i class="fas fa-pen"></i></div>
                    <div class="btn-icon btn-red" onclick="delItem('${fUid}','${i.id}',${i.price})"><i class="fas fa-trash"></i></div></div></div>`;
                });
            }
        }

        window.adminGiveItem = async () => {
            if(!fUid) return;
            const nm = document.getElementById('adm-issue-item').value;
            const pr = Number(document.getElementById('adm-issue-price').value);
            const dur = Number(document.getElementById('adm-issue-dur').value);
            const unit = document.getElementById('adm-issue-unit').value;
            let d = new Date(); 
            if(unit==='hours') d.setHours(d.getHours()+dur);
            if(unit==='days') d.setDate(d.getDate()+dur);
            if(unit==='months') d.setMonth(d.getMonth()+dur);
            if(unit==='years') d.setFullYear(d.getFullYear()+dur);

            const newItem = { id: Date.now().toString()+Math.random().toString().slice(2), name: nm, price: pr, date: new Date().toISOString(), expiryDate: d.toISOString() };
            const trans = { amount: pr, reason: "–ü–æ–∫—É–ø–∫–∞: "+nm, date: new Date().toISOString() };
            
            await updateDoc(doc(db,"users",fUid), { items: arrayUnion(newItem), spent: increment(pr), transactions: arrayUnion(trans) });
            alert("–û–ö"); adminFindUser();
        }

        window.openEdit = async (uid, iid) => {
            const s = await getDoc(doc(db,"users",uid));
            const item = s.data().items.find(x => x.id === iid);
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-item-id').value = iid;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-price').value = item.price;
            document.getElementById('edit-old-price').value = item.price;
            let dt = new Date(item.expiryDate); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());
            document.getElementById('edit-date').value = dt.toISOString().slice(0,16);
            document.getElementById('edit-modal').style.display='flex';
        }

        window.saveEditedItem = async () => {
            const uid = document.getElementById('edit-user-id').value;
            const iid = document.getElementById('edit-item-id').value;
            const np = Number(document.getElementById('edit-price').value);
            const op = Number(document.getElementById('edit-old-price').value);
            const nn = document.getElementById('edit-name').value;
            const nd = new Date(document.getElementById('edit-date').value).toISOString();

            const r = doc(db,"users",uid);
            const s = await getDoc(r);
            let arr = s.data().items;
            const idx = arr.findIndex(x => x.id === iid);
            if(idx > -1) {
                arr[idx].name=nn; arr[idx].price=np; arr[idx].expiryDate=nd;
                await updateDoc(r, { items: arr, spent: increment(np-op) });
                document.getElementById('edit-modal').style.display='none';
                alert("Saved"); adminFindUser();
            }
        }
        window.closeModal = () => document.getElementById('edit-modal').style.display='none';

        window.delItem = async (uid, iid, p) => {
            if(confirm("Del?")) {
                const r = doc(db,"users",uid);
                const s = await getDoc(r);
                const arr = s.data().items.filter(x => x.id !== iid);
                const trans = { amount: -p, reason: "–£–¥–∞–ª–µ–Ω–∏–µ", date: new Date().toISOString() };
                await updateDoc(r, { items: arr, spent: increment(-p), transactions: arrayUnion(trans) });
                adminFindUser();
            }
        }

        init();
    </script>
</body>
</html>
