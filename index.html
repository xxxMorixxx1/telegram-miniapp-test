<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RakStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* BASE THEME */
        :root { --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --red: #ff3b30; --green: #30d158; --gray: #8e8e93; --gold: #ffd700; --blue: #0a84ff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; transition: 0.5s; }

        /* SEASONAL CONTAINER */
        #seasonal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: hidden; }
        /* (Seasonal styles preserved from previous version...) */
        body.mode-halloween { background: radial-gradient(circle at 50% 10%, #4a0e0e, #000000); --red: #ff4500; }
        body.mode-newyear { background: linear-gradient(180deg, #021b35 0%, #000510 100%); --red: #00bfff; }
        .snow-flake { position: absolute; color: white; animation: fall 8s linear infinite; }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* UI ELEMENTS */
        header { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--card); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 24px; font-weight: 900; color: var(--red); text-transform: uppercase; }
        
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* PROFILE */
        .profile-header { text-align: center; margin-bottom: 20px; }
        .avatar-box { width: 100px; height: 100px; border-radius: 50%; background: #444; margin: 0 auto 10px; overflow: hidden; border: 3px solid var(--red); position: relative; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 20px; font-weight: bold; }
        .profile-id { font-size: 12px; color: var(--gray); }

        /* WARRANTY CARD */
        .warranty-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 12px; position: relative; overflow: hidden; }
        .warranty-card.gift { border: 1px solid var(--gold); }
        .w-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .w-bar-bg { background: #444; height: 6px; border-radius: 3px; margin: 8px 0; overflow: hidden; }
        .w-bar-fill { height: 100%; background: var(--green); transition: width 0.5s; }
        .w-bar-fill.low { background: var(--red); }
        .w-footer { font-size: 11px; color: var(--gray); display: flex; justify-content: space-between; }
        .gift-badge { background: var(--gold); color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* LEADERBOARD */
        .leader-item { background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; }
        .l-rank { width: 30px; font-weight: bold; text-align: center; }
        .l-avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; margin-right: 10px; object-fit: cover; }
        .l-info { flex-grow: 1; }
        .l-name { font-weight: bold; font-size: 14px; }
        .l-spent { color: var(--gold); font-size: 13px; }

        /* ADMIN & INPUTS */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .admin-tab { background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .admin-tab.active { background: var(--red); color: white; }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* PHONE BLOCKER */
        #phone-blocker { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 30px; text-align: center; }
        
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: gray; width: 20%; cursor: pointer; }
        .nav-item.active { color: var(--red); transform: scale(1.1); transition: 0.2s; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        
        .list-item-row { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; display:flex; justify-content:space-between; align-items:center; font-size: 13px;}
        .btn-icon { background: #444; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 5px; margin-left: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="seasonal-container"></div>

    <!-- PHONE BLOCKER MODAL -->
    <div id="phone-blocker">
        <i class="fas fa-mobile-alt" style="font-size: 50px; color: var(--red); margin-bottom: 20px;"></i>
        <h2>–ü—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–º–µ—Ä–∞</h2>
        <p style="color: gray; margin-bottom: 20px;">–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RakStore –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É.</p>
        <input type="tel" id="mandatory-phone" placeholder="+7 (999) 000-00-00">
        <button onclick="savePhone()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <header>
        <div class="brand">RakStore</div>
    </header>

    <!-- 1. HOME -->
    <div id="home" class="page active">
        <div class="level-card" style="background: linear-gradient(135deg, var(--red), #ff9f0a); padding: 20px; border-radius: 20px; text-align: center;">
            <div>–£–†–û–í–ï–ù–¨: <span id="lvl-display">1</span></div>
            <div style="font-size:40px; font-weight:bold; margin:10px 0;" id="discount-display">5%</div>
            <div style="background:rgba(0,0,0,0.2); height:6px; border-radius:3px; overflow:hidden;"><div id="xp-fill" style="background:white; height:100%; width:0%"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:5px;">
                <span id="rub-current">0</span> <span>100 000‚ÇΩ</span>
            </div>
        </div>
        
        <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <button onclick="navTo('bonuses')" style="margin-bottom:10px; background:#333"><i class="fas fa-gift"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <button onclick="navTo('profile')" style="background:#333"><i class="fas fa-user-edit"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <!-- 2. HISTORY -->
    <div id="history" class="page">
        <h3>–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h3>
        <div id="history-list"></div>
    </div>

    <!-- 3. LEADERBOARD -->
    <div id="leaderboard" class="page">
        <h2>üèÜ –¢–æ–ø –º–∞–∂–æ—Ä–æ–≤</h2>
        <div id="leaderboard-list">Loading...</div>
    </div>

    <!-- 4. PROFILE -->
    <div id="profile" class="page">
        <div class="profile-header">
            <div class="avatar-box">
                <img id="profile-avatar" src="" class="avatar-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            </div>
            <div class="profile-name" id="profile-name-disp">Guest</div>
            <div class="profile-id" id="profile-phone-disp">–ù–µ—Ç –Ω–æ–º–µ—Ä–∞</div>
        </div>

        <div style="background:var(--card); padding:15px; border-radius:15px;">
            <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h4>
            <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:</label>
            <input type="text" id="inp-custom-name" placeholder="–í–∞—à –Ω–∏–∫">
            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É:</label>
            <input type="text" id="inp-avatar-url" placeholder="https://...">
            <button onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- 5. BONUSES (Hidden from Nav, accessible via Home) -->
    <div id="bonuses" class="page">
        <h2>–ë–æ–Ω—É—Å—ã</h2>
        <div style="background:#333; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px;">
            <div style="font-size:30px; color:var(--gold); font-weight:bold;"><span id="bonus-balance">0</span> B</div>
            <div style="color:gray; font-size:12px;">–ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤</div>
        </div>
        <input type="text" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
        <button onclick="activatePromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- 6. ADMIN -->
    <div id="admin" class="page">
        <h2 style="color: var(--red)">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <div id="admin-login">
            <input type="password" id="adm-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="admin-controls" style="display:none;">
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="swTab('adm-users',this)">–Æ–∑–µ—Ä—ã</div>
                <div class="admin-tab" onclick="swTab('adm-products',this)">–¢–æ–≤–∞—Ä—ã</div>
                <div class="admin-tab" onclick="swTab('adm-theme',this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- TAB: USERS & ISSUANCE -->
            <div id="adm-users" class="admin-section active">
                <input type="text" id="adm-search" placeholder="–ü–æ–∏—Å–∫ @username">
                <button onclick="admFindUser()" style="background:#333; margin-bottom:15px;">–ù–∞–π—Ç–∏</button>
                
                <div id="issue-panel" style="display:none; border-top:1px solid #444; padding-top:15px;">
                    <div style="background:#333; padding:10px; border-radius:10px; margin-bottom:15px;">
                        <div><b id="target-real-name"></b></div>
                        <div style="font-size:12px; color:gray;" id="target-phone"></div>
                        <div style="font-size:12px; color:var(--red);" id="target-username"></div>
                    </div>

                    <h4>–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h4>
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:</label>
                    <select id="adm-product-select"></select>
                    
                    <label>–°—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏–∏:</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="adm-dur" value="30">
                        <select id="adm-unit">
                            <option value="days">–î–Ω–µ–π</option>
                            <option value="months">–ú–µ—Å—è—Ü–µ–≤</option>
                            <option value="years">–õ–µ—Ç</option>
                        </select>
                    </div>
                    <button onclick="admGiveProduct()">–í—ã–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                </div>
            </div>

            <!-- TAB: PRODUCTS MANAGEMENT -->
            <div id="adm-products" class="admin-section">
                <h4>–°–æ–∑–¥–∞—Ç—å –¢–æ–≤–∞—Ä</h4>
                <input type="text" id="new-prod-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (Spotify)">
                <input type="number" id="new-prod-price" placeholder="–¶–µ–Ω–∞ (RUB)">
                
                <label>–ü—Ä–∏–≤—è–∑–∫–∞ (–ø–æ–¥–∞—Ä–æ–∫ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ):</label>
                <select id="new-prod-link">
                    <option value="">–ù–µ—Ç</option>
                </select>
                <p style="font-size:10px; color:gray;">–ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É, —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º.</p>

                <button onclick="admCreateProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                
                <h4 style="margin-top:20px;">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤:</h4>
                <div id="products-list"></div>
            </div>

            <!-- TAB: THEME -->
            <div id="adm-theme" class="admin-section">
                <h4>–†–µ–∂–∏–º</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="setTheme('default')" style="background:#333">Default</button>
                    <button onclick="setTheme('newyear')" style="background:#004080">New Year</button>
                    <button onclick="setTheme('halloween')" style="background:#662200">Halloween</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i><br>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-item" onclick="navTo('history')"><i class="fas fa-history"></i><br>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="nav-item" onclick="navTo('leaderboard')"><i class="fas fa-trophy"></i><br>–¢–æ–ø</div>
        <div class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i><br>–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="nav-item" onclick="navTo('admin')"><i class="fas fa-cog"></i><br>–ê–¥–º–∏–Ω</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment, collection, query, where, getDocs, orderBy, limit, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // === CONFIG ===
        const MY_ADMIN_PASSWORD = "123";
        const firebaseConfig = {
             apiKey: "AIzaSyDFrEbOwmtZlWlrPhImDlA0PE1tQKvYNAY",
             authDomain: "rakstore-a80a8.firebaseapp.com",
             projectId: "rakstore-a80a8",
             storageBucket: "rakstore-a80a8.firebasestorage.app",
             messagingSenderId: "55025016203",
             appId: "1:55025016203:web:8a6b67666dbb3df285238e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myUserId = tg.initDataUnsafe?.user?.id || 11111;
        let myUsername = tg.initDataUnsafe?.user?.username || "unknown";
        if(myUsername) myUsername = myUsername.toLowerCase();
        
        // INIT
        async function init() {
            // Theme
            const sets = await getDoc(doc(db,"settings","general"));
            if(sets.exists() && sets.data().theme) document.body.className = `mode-${sets.data().theme}`;

            // User
            const userRef = doc(db, "users", myUserId.toString());
            const snap = await getDoc(userRef);
            
            if(!snap.exists()) {
                // New User
                await setDoc(userRef, { 
                    username: myUsername, 
                    name: tg.initDataUnsafe?.user?.first_name || "Guest",
                    spent: 0, items: [], bonusBalance: 0 
                });
                showPhoneBlocker();
            } else {
                const d = snap.data();
                if(!d.phoneNumber) showPhoneBlocker();
                if(d.username !== myUsername) updateDoc(userRef, { username: myUsername });
                renderUI(d);
            }
        }

        function showPhoneBlocker() {
            document.getElementById('phone-blocker').style.display = 'flex';
        }

        window.savePhone = async () => {
            const p = document.getElementById('mandatory-phone').value;
            if(p.length < 10) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä");
            await updateDoc(doc(db, "users", myUserId.toString()), { phoneNumber: p });
            document.getElementById('phone-blocker').style.display = 'none';
            location.reload();
        }

        function renderUI(u) {
            // XP & Level
            const lvl = Math.floor(u.spent/100000)+1;
            document.getElementById('lvl-display').innerText = lvl;
            document.getElementById('discount-display').innerText = (lvl*5)+"%";
            document.getElementById('rub-current').innerText = (u.spent%100000).toLocaleString();
            document.getElementById('xp-fill').style.width = ((u.spent%100000)/100000*100)+"%";

            // Profile
            document.getElementById('profile-name-disp').innerText = u.customName || u.name;
            document.getElementById('profile-phone-disp').innerText = u.phoneNumber || "No Phone";
            if(u.avatarUrl) document.getElementById('profile-avatar').src = u.avatarUrl;
            document.getElementById('bonus-balance').innerText = u.bonusBalance || 0;

            // History with Dynamic Warranty
            const hList = document.getElementById('history-list');
            hList.innerHTML = "";
            if(u.items) {
                [...u.items].reverse().forEach(i => {
                    const now = new Date();
                    const exp = new Date(i.expiryDate);
                    const totalDur = exp - new Date(i.date);
                    const left = exp - now;
                    const daysLeft = Math.ceil(left / (1000*60*60*24));
                    
                    let barPercent = 0;
                    let label = "–ò—Å—Ç–µ–∫–ª–æ";
                    let isLow = false;

                    if(left > 0) {
                        barPercent = (left / totalDur) * 100;
                        label = `–û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥–Ω.`;
                        if(barPercent < 20) isLow = true;
                    }

                    hList.innerHTML += `
                    <div class="warranty-card ${i.isGift?'gift':''}">
                        <div class="w-header">
                            <span>${i.name}</span>
                            <span>${i.isGift ? 'üéÅ' : i.price+'‚ÇΩ'}</span>
                        </div>
                        <div class="w-bar-bg">
                            <div class="w-bar-fill ${isLow?'low':''}" style="width:${barPercent}%"></div>
                        </div>
                        <div class="w-footer">
                            <span>${new Date(i.date).toLocaleDateString()}</span>
                            <span style="color:${left>0?'var(--text)':'var(--red)'}">${label}</span>
                        </div>
                        ${i.isGift ? '<div class="gift-badge">–ü–û–î–ê–†–û–ö</div>' : ''}
                    </div>`;
                });
            }
        }

        window.updateProfile = async () => {
            const cn = document.getElementById('inp-custom-name').value;
            const av = document.getElementById('inp-avatar-url').value;
            await updateDoc(doc(db,"users",myUserId.toString()), { customName: cn, avatarUrl: av });
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); location.reload();
        }

        // LEADERBOARD
        window.loadLeaderboard = async () => {
            const l = document.getElementById('leaderboard-list');
            l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const q = query(collection(db,"users"), orderBy("spent","desc"), limit(10));
            const s = await getDocs(q);
            l.innerHTML = "";
            let i=1;
            s.forEach(d => {
                const u = d.data();
                l.innerHTML += `
                <div class="leader-item">
                    <div class="l-rank">${i}</div>
                    <img src="${u.avatarUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="l-avatar">
                    <div class="l-info">
                        <div class="l-name">${u.customName || u.name}</div>
                        <div class="l-spent">${u.spent.toLocaleString()}‚ÇΩ</div>
                    </div>
                </div>`;
                i++;
            });
        }

        // ADMIN
        window.adminLogin = () => {
            if(document.getElementById('adm-pass').value === MY_ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display='none';
                document.getElementById('admin-controls').style.display='block';
                loadProductsAdmin();
            }
        }
        window.swTab = (id, el) => {
            document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
        }

        // Product Manager
        async function loadProductsAdmin() {
            const list = document.getElementById('products-list');
            const sel = document.getElementById('new-prod-link');
            const issSel = document.getElementById('adm-product-select');
            
            list.innerHTML = "";
            sel.innerHTML = '<option value="">–ù–µ—Ç</option>';
            issSel.innerHTML = "";

            const snap = await getDocs(collection(db, "predefined_products"));
            snap.forEach(d => {
                const p = d.data();
                // Admin List
                list.innerHTML += `<div class="list-item-row">
                    <span>${p.name} (${p.price}‚ÇΩ) ${p.linkedId?'üîó':''}</span>
                    <div class="btn-icon btn-red" onclick="delProd('${d.id}')">üóë</div>
                </div>`;
                // Dropdowns
                const opt = `<option value="${d.id}">${p.name} (${p.price}‚ÇΩ)</option>`;
                sel.innerHTML += opt;
                issSel.innerHTML += opt;
            });
        }

        window.admCreateProduct = async () => {
            const n = document.getElementById('new-prod-name').value;
            const p = Number(document.getElementById('new-prod-price').value);
            const l = document.getElementById('new-prod-link').value;
            if(!n) return;
            await updateDoc(doc(collection(db,"predefined_products")), { name:n, price:p, linkedId:l });
            loadProductsAdmin();
            alert("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω");
        }
        window.delProd = async (id) => { if(confirm("Del?")) { await deleteDoc(doc(db,"predefined_products",id)); loadProductsAdmin(); }}

        // User Find & Issue
        let targetUid = null;
        window.admFindUser = async () => {
            const u = document.getElementById('adm-search').value.toLowerCase().replace("@","");
            const q = query(collection(db,"users"), where("username","==",u));
            const s = await getDocs(q);
            if(s.empty) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω");
            
            const data = s.docs[0].data();
            targetUid = s.docs[0].id;
            
            document.getElementById('issue-panel').style.display = 'block';
            document.getElementById('target-real-name').innerText = data.customName || data.name;
            document.getElementById('target-phone').innerText = data.phoneNumber || "–ë–µ–∑ –Ω–æ–º–µ—Ä–∞";
            document.getElementById('target-username').innerText = "@"+data.username;
        }

        window.admGiveProduct = async () => {
            if(!targetUid) return;
            const prodId = document.getElementById('adm-product-select').value;
            const dur = Number(document.getElementById('adm-dur').value);
            const unit = document.getElementById('adm-unit').value;

            // Get Product Data
            const pSnap = await getDoc(doc(db,"predefined_products",prodId));
            if(!pSnap.exists()) return;
            const prod = pSnap.data();

            // Calc Date
            let d = new Date();
            if(unit==='days') d.setDate(d.getDate()+dur);
            if(unit==='months') d.setMonth(d.getMonth()+dur);
            if(unit==='years') d.setFullYear(d.getFullYear()+dur);

            // Give Main Item
            const mainItem = { id: Date.now().toString(), name: prod.name, price: prod.price, date: new Date().toISOString(), expiryDate: d.toISOString(), isGift: false };
            
            const uRef = doc(db,"users",targetUid);
            await updateDoc(uRef, { items: arrayUnion(mainItem), spent: increment(prod.price) });

            // Check Linked
            if(prod.linkedId) {
                const lSnap = await getDoc(doc(db,"predefined_products",prod.linkedId));
                if(lSnap.exists()) {
                    const lProd = lSnap.data();
                    const linkedItem = { 
                        id: Date.now().toString()+"L", 
                        name: lProd.name + " (–ë–æ–Ω—É—Å)", 
                        price: 0, 
                        date: new Date().toISOString(), 
                        expiryDate: d.toISOString(), // Same duration
                        isGift: true 
                    };
                    await updateDoc(uRef, { items: arrayUnion(linkedItem) });
                    alert(`–í—ã–¥–∞–Ω ${prod.name} + ${lProd.name}!`);
                } else {
                    alert(`–í—ã–¥–∞–Ω ${prod.name}`);
                }
            } else {
                alert(`–í—ã–¥–∞–Ω ${prod.name}`);
            }
        }

        // PROMO
        window.activatePromo = async () => {
             const c = document.getElementById('promo-input').value.toUpperCase();
             const snap = await getDoc(doc(db,"promocodes",c));
             if(snap.exists() && !snap.data().users.includes(myUserId.toString())) {
                 await updateDoc(doc(db,"users",myUserId.toString()), { bonusBalance: increment(snap.data().value) });
                 await updateDoc(doc(db,"promocodes",c), { users: arrayUnion(myUserId.toString()) });
                 alert("OK"); location.reload();
             } else alert("–û—à–∏–±–∫–∞");
        }

        // THEME
        window.setTheme = async (t) => {
            await setDoc(doc(db,"settings","general"), {theme:t}, {merge:true});
            alert("Theme set");
        }

        // Nav
        window.navTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active'); else n.classList.remove('active');
            });
            if(id === 'leaderboard') loadLeaderboard();
        }

        init();
    </script>
</body>
</html>
