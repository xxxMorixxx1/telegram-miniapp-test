<style>
    /* === 1. –ë–ê–ó–ê === */
    :root { 
        --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; 
        --red: #ff3b30; --green: #30d158; --gray: #8e8e93; --gold: #ffd700; 
    }
    
    body { 
        background: var(--bg); color: var(--text); 
        font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
        margin: 0; padding-bottom: 80px; overflow-x: hidden; 
        transition: background 0.8s ease, color 0.5s;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (—Å–Ω–µ–≥, –ª–∏—Å—Ç—å—è –∏ —Ç.–¥.) */
    #seasonal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }

    /* === 2. –°–ï–ó–û–ù–ù–´–ï –†–ï–ñ–ò–ú–´ === */

    /* üéÉ HALLOWEEN: –ö—Ä–æ–≤–∞–≤—ã–π —Ç—É–º–∞–Ω + –ü—Ä–∏–∑—Ä–∞–∫–∏ */
    body.mode-halloween { 
        background: radial-gradient(circle at 50% -20%, #660000, #2b0202, #000000); 
        --red: #ff4500; --card: rgba(60, 10, 5, 0.8); 
    }
    .particle-ghost { 
        position: absolute; font-size: 25px; opacity: 0; 
        animation: floatGhost linear infinite; 
        filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
    }
    @keyframes floatGhost { 
        0% { transform: translateY(110vh) scale(0.5) rotate(-10deg); opacity: 0; }
        20% { opacity: 0.6; }
        80% { opacity: 0.6; }
        100% { transform: translateY(-10vh) scale(1.2) rotate(10deg); opacity: 0; }
    }

    /* ‚ùÑÔ∏è NEW YEAR: –°–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ + –°–Ω–µ–≥ */
    body.mode-newyear { 
        background: linear-gradient(160deg, #0b1026 0%, #2b32b2 100%); 
        --red: #00d2ff; --green: #00ff9d; --card: rgba(11, 16, 38, 0.85); 
    }
    .particle-snow { 
        position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; 
        box-shadow: 0 0 5px white; animation: fallSnow linear infinite; 
    }
    @keyframes fallSnow { 
        0% { transform: translateY(-10vh) translateX(0); opacity: 0.8; }
        100% { transform: translateY(110vh) translateX(20px); opacity: 0.4; } 
    }

    /* üçÇ AUTUMN: –¢–µ–ø–ª—ã–π –ª–µ—Å + –õ–∏—Å—Ç–æ–ø–∞–¥ */
    body.mode-autumn { 
        background: linear-gradient(135deg, #3e2723, #5d4037, #1a1000); 
        --red: #ff6f00; --green: #ffd54f; --card: rgba(62, 39, 35, 0.85); 
    }
    .particle-leaf { 
        position: absolute; font-size: 18px; color: #ff6f00; 
        animation: fallLeaf linear infinite; 
    }
    @keyframes fallLeaf { 
        0% { transform: translateY(-10vh) rotate(0deg) translateX(0); opacity: 1; }
        100% { transform: translateY(110vh) rotate(360deg) translateX(50px); opacity: 0; } 
    }

    /* ‚òÄÔ∏è SUMMER: –ó–∞–∫–∞—Ç –Ω–∞ –ø–ª—è–∂–µ + –°–≤–µ—Ç–ª—è—á–∫–∏/–ë–ª–∏–∫–∏ */
    body.mode-summer { 
        background: linear-gradient(to bottom, #ff512f, #dd2476, #2c3e50); /* Sunset */
        --red: #ffd700; --card: rgba(50, 20, 40, 0.7); 
    }
    .particle-sun { 
        position: absolute; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, transparent 70%); 
        animation: floatSun 10s infinite alternate; mix-blend-mode: screen; 
    }
    @keyframes floatSun { 
        0% { transform: translate(0, 0) scale(1); } 
        100% { transform: translate(20px, -20px) scale(1.5); } 
    }

    /* üå∏ SPRING: –ù–æ—á–Ω–æ–π —Å–∞–¥ + –°–∞–∫—É—Ä–∞ */
    body.mode-spring { 
        background: linear-gradient(to bottom, #1a2980, #26d0ce); 
        --red: #ff69b4; --green: #00fa9a; --card: rgba(26, 41, 128, 0.7); 
    }
    .particle-flower { 
        position: absolute; font-size: 14px; color: #ffb7b2; 
        animation: fallFlower linear infinite; 
    }
    @keyframes fallFlower { 
        0% { transform: translateY(-10vh) rotate(0deg) translateX(-10px); }
        50% { transform: translateY(50vh) rotate(180deg) translateX(10px); }
        100% { transform: translateY(110vh) rotate(360deg) translateX(-10px); }
    }

    /* === 3. UI –ò–ù–¢–ï–†–§–ï–ô–° === */
    /* –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫, –∫–Ω–æ–ø–æ–∫ –∏ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –ª–æ–≥–∏–∫—É */
    header { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--card); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .brand { font-size: 24px; font-weight: 900; color: var(--red); text-transform: uppercase; text-shadow: 0 0 15px currentColor; }
    
    .page { display: none; padding: 20px; position: relative; z-index: 10; } /* z-index —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –Ω–∞–¥ —á–∞—Å—Ç–∏—Ü–∞–º–∏ */
    .page.active { display: block; animation: zoomIn 0.3s; }
    @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (inputs, profile, leaderboard) —Å–∫–æ–ø–∏—Ä—É–π –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å */
    /* ... (–°—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å—Ç–∏–ª–∏ –¥–ª—è .profile-header, .warranty-card, input, button –∏ —Ç.–¥. –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –æ—Ç–≤–µ—Ç–∞) ... */
    
    /* –°—Ç–∏–ª–∏ –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–æ–≤ */
    .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .theme-btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; }
    .theme-btn:active { transform: scale(0.95); }
    
    /* –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ –≤ –∞–¥–º–∏–Ω–∫–µ */
    .btn-def { background: #333; }
    .btn-hal { background: linear-gradient(45deg, #8E0E00, #1F1C18); }
    .btn-new { background: linear-gradient(45deg, #00c6ff, #0072ff); }
    .btn-aut { background: linear-gradient(45deg, #f12711, #f5af19); }
    .btn-sum { background: linear-gradient(45deg, #ff512f, #dd2476); }
    .btn-spr { background: linear-gradient(45deg, #11998e, #38ef7d); }

    /* (–í—Å—Ç–∞–≤—å —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∫–æ–¥–∞) */
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
    .admin-tab { background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; z-index: 20; position: relative;}
    .admin-tab.active { background: var(--red); color: white; }
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    
    input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; box-sizing: border-box; backdrop-filter: blur(5px); }
    button { width: 100%; padding: 15px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 90; }
    .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: gray; width: 20%; cursor: pointer; }
    .nav-item.active { color: var(--red); transform: scale(1.1); transition: 0.2s; }
    .nav-item i { font-size: 18px; margin-bottom: 4px; }
    
    /* Phone Blocker & Modal */
    #phone-blocker { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 30px; text-align: center; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1); }
</style>
<body>
    <div id="seasonal-container"></div>

    <!-- –û–ö–ù–û –ë–õ–û–ö–ò–†–û–í–ö–ò (–í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞) -->
    <div id="phone-blocker">
        <i class="fas fa-mobile-alt" style="font-size: 50px; color: var(--red); margin-bottom: 20px;"></i>
        <h2>–ü—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–º–µ—Ä–∞</h2>
        <p style="color: gray; margin-bottom: 20px;">–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è RakStore –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ –∞–∫–∫–∞—É–Ω—Ç—É.</p>
        <input type="tel" id="mandatory-phone" placeholder="+7 (999) 000-00-00">
        <button onclick="savePhone()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <header>
        <div class="brand">RakStore</div>
    </header>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –ì–õ–ê–í–ù–ê–Ø -->
    <div id="home" class="page active">
        <div class="level-card" style="background: linear-gradient(135deg, var(--red), #ff9f0a); padding: 20px; border-radius: 20px; text-align: center;">
            <div>–£–†–û–í–ï–ù–¨: <span id="lvl-display">1</span></div>
            <div style="font-size:40px; font-weight:bold; margin:10px 0;" id="discount-display">5%</div>
            <div style="background:rgba(0,0,0,0.2); height:6px; border-radius:3px; overflow:hidden;"><div id="xp-fill" style="background:white; height:100%; width:0%"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:5px;">
                <span id="rub-current">0</span> <span>100 000‚ÇΩ</span>
            </div>
        </div>
        
        <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <button onclick="navTo('bonuses')" style="margin-bottom:10px; background:#333"><i class="fas fa-gift"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <button onclick="navTo('profile')" style="background:#333"><i class="fas fa-user-edit"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –ò–°–¢–û–†–ò–Ø -->
    <div id="history" class="page">
        <h3>–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</h3>
        <div id="history-list"></div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –¢–û–ü -->
    <div id="leaderboard" class="page">
        <h2>üèÜ –¢–æ–ø –º–∞–∂–æ—Ä–æ–≤</h2>
        <div id="leaderboard-list">Loading...</div>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –ü–†–û–§–ò–õ–¨ -->
    <div id="profile" class="page">
        <div class="profile-header">
            <div class="avatar-box">
                <img id="profile-avatar" src="" class="avatar-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            </div>
            <div class="profile-name" id="profile-name-disp">Guest</div>
            <div class="profile-id" id="profile-phone-disp">–ù–µ—Ç –Ω–æ–º–µ—Ä–∞</div>
        </div>

        <div style="background:var(--card); padding:15px; border-radius:15px;">
            <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h4>
            <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:</label>
            <input type="text" id="inp-custom-name" placeholder="–í–∞—à –Ω–∏–∫">
            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É:</label>
            <input type="text" id="inp-avatar-url" placeholder="https://...">
            <button onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –°–¢–†–ê–ù–ò–¶–ê: –ë–û–ù–£–°–´ -->
    <div id="bonuses" class="page">
        <h2>–ë–æ–Ω—É—Å—ã</h2>
        <div style="background:#333; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px;">
            <div style="font-size:30px; color:var(--gold); font-weight:bold;"><span id="bonus-balance">0</span> B</div>
            <div style="color:gray; font-size:12px;">–ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤</div>
        </div>
        <input type="text" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
        <button onclick="activatePromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin" class="page">
        <h2 style="color: var(--red)">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
        <div id="admin-login">
            <input type="password" id="adm-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="admin-controls" style="display:none;">
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="swTab('adm-users',this)">–Æ–∑–µ—Ä—ã</div>
                <div class="admin-tab" onclick="swTab('adm-products',this)">–¢–æ–≤–∞—Ä—ã</div>
                <div class="admin-tab" onclick="swTab('adm-theme',this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <!-- –ê–¥–º–∏–Ω–∫–∞: –í–∫–ª–∞–¥–∫–∞ –Æ–∑–µ—Ä—ã -->
            <div id="adm-users" class="admin-section active">
                <input type="text" id="adm-search" placeholder="–ü–æ–∏—Å–∫ @username">
                <button onclick="admFindUser()" style="background:#333; margin-bottom:15px;">–ù–∞–π—Ç–∏</button>
                
                <div id="issue-panel" style="display:none; border-top:1px solid #444; padding-top:15px;">
                    <div style="background:#333; padding:10px; border-radius:10px; margin-bottom:15px;">
                        <div><b id="target-real-name"></b></div>
                        <div style="font-size:12px; color:gray;" id="target-phone"></div>
                        <div style="font-size:12px; color:var(--red);" id="target-username"></div>
                    </div>

                    <h4>–í—ã–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h4>
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:</label>
                    <select id="adm-product-select"></select>
                    
                    <label>–°—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏–∏:</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="adm-dur" value="30">
                        <select id="adm-unit">
                            <option value="days">–î–Ω–µ–π</option>
                            <option value="months">–ú–µ—Å—è—Ü–µ–≤</option>
                            <option value="years">–õ–µ—Ç</option>
                        </select>
                    </div>
                    <button onclick="admGiveProduct()">–í—ã–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                </div>
            </div>

            <!-- –ê–¥–º–∏–Ω–∫–∞: –í–∫–ª–∞–¥–∫–∞ –¢–æ–≤–∞—Ä—ã -->
            <div id="adm-products" class="admin-section">
                <h4>–°–æ–∑–¥–∞—Ç—å –¢–æ–≤–∞—Ä</h4>
                <input type="text" id="new-prod-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (Spotify)">
                <input type="number" id="new-prod-price" placeholder="–¶–µ–Ω–∞ (RUB)">
                
                <label>–ü—Ä–∏–≤—è–∑–∫–∞ (–ø–æ–¥–∞—Ä–æ–∫ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ):</label>
                <select id="new-prod-link">
                    <option value="">–ù–µ—Ç</option>
                </select>
                <p style="font-size:10px; color:gray;">–ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É, —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º.</p>

                <button onclick="admCreateProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                
                <h4 style="margin-top:20px;">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤:</h4>
                <div id="products-list"></div>
            </div>

            <!-- –ê–¥–º–∏–Ω–∫–∞: –í–∫–ª–∞–¥–∫–∞ –¢–µ–º—ã -->
             <!-- –ê–¥–º–∏–Ω–∫–∞: –í–∫–ª–∞–¥–∫–∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–¢–µ–º—ã) -->
            <div id="adm-theme" class="admin-section">
                <h4>üé® –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∑–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º</h4>
                <div class="theme-grid">
                    <button class="theme-btn btn-def" onclick="setTheme('default')">‚ö´ –°—Ç–∞–Ω–¥–∞—Ä—Ç</button>
                    <button class="theme-btn btn-hal" onclick="setTheme('halloween')">üéÉ –•—ç–ª–ª–æ—É–∏–Ω</button>
                    <button class="theme-btn btn-new" onclick="setTheme('newyear')">‚ùÑÔ∏è –ù–æ–≤—ã–π –ì–æ–¥</button>
                    <button class="theme-btn btn-aut" onclick="setTheme('autumn')">üçÇ –û—Å–µ–Ω—å</button>
                    <button class="theme-btn btn-sum" onclick="setTheme('summer')">‚òÄÔ∏è –õ–µ—Ç–æ</button>
                    <button class="theme-btn btn-spr" onclick="setTheme('spring')">üå∏ –í–µ—Å–Ω–∞</button>
                </div>
                <p style="font-size:10px; color:gray; margin-top:10px;">–≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
            </div>
        </div>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ) -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i><br>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-item" onclick="navTo('history')"><i class="fas fa-history"></i><br>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="nav-item" onclick="navTo('leaderboard')"><i class="fas fa-trophy"></i><br>–¢–æ–ø</div>
        <div class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i><br>–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="nav-item" onclick="navTo('admin')"><i class="fas fa-cog"></i><br>–ê–¥–º–∏–Ω</div>
    </nav>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment, collection, query, where, getDocs, orderBy, limit, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
                // --- –õ–û–ì–ò–ö–ê –¢–ï–ú –ò –≠–§–§–ï–ö–¢–û–í ---
        
        // 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –≤ –±–∞–∑—É (–ê–¥–º–∏–Ω)
        window.setTheme = async (t) => {
            await setDoc(doc(db,"settings","general"), {theme:t}, {merge:true});
            applyThemeLocal(t); // –°—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º —É —Å–µ–±—è
            alert(`–†–µ–∂–∏–º ${t} –≤–∫–ª—é—á–µ–Ω!`);
        }

        // 2. –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã (–ö–ª–∏–µ–Ω—Ç)
        function applyThemeLocal(mode) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã body
            document.body.className = ""; 
            const container = document.getElementById('seasonal-container');
            container.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞—Å—Ç–∏—Ü—ã

            if (mode && mode !== 'default') {
                document.body.classList.add(`mode-${mode}`);
                
                // –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —á–∞—Å—Ç–∏—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (mode === 'halloween') spawnParticles(container, 'particle-ghost', ['üëª', 'ü¶á'], 15);
                if (mode === 'newyear') spawnParticles(container, 'particle-snow', [''], 40); // –ü—É—Å—Ç–æ–π —Å–∏–º–≤–æ–ª, —Ç.–∫. —Å—Ç–∏–ª—å CSS –¥–µ–ª–∞–µ—Ç —Ç–æ—á–∫—É
                if (mode === 'autumn') spawnParticles(container, 'particle-leaf', ['üçÇ', 'üçÅ'], 20);
                if (mode === 'spring') spawnParticles(container, 'particle-flower', ['üå∏', 'üå∫'], 25);
                if (mode === 'summer') {
                    // –î–ª—è –ª–µ—Ç–∞ –æ—Å–æ–±—ã–µ –±–ª–∏–∫–∏
                    for(let i=0; i<3; i++) {
                        let el = document.createElement('div');
                        el.className = 'particle-sun';
                        el.style.left = Math.random()*100 + '%';
                        el.style.top = Math.random()*50 + '%';
                        container.appendChild(el);
                    }
                }
            }
        }

        // 3. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —á–∞—Å—Ç–∏—Ü
        function spawnParticles(container, cssClass, symbols, count) {
            for (let i = 0; i < count; i++) {
                let el = document.createElement('div');
                el.className = cssClass;
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã —Å–∏–º–≤–æ–ª—ã (—ç–º–æ–¥–∑–∏), –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
                if (symbols[0] !== '') {
                    el.innerText = symbols[Math.floor(Math.random() * symbols.length)];
                }
                
                // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
                el.style.left = Math.random() * 100 + "vw";
                el.style.animationDuration = (Math.random() * 5 + 5) + "s"; // –æ—Ç 5 –¥–æ 10 —Å–µ–∫
                el.style.animationDelay = (Math.random() * 5) + "s"; // –∑–∞–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—Ç–∞
                el.style.fontSize = (Math.random() * 15 + 10) + "px"; // —Ä–∞–∑–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                
                container.appendChild(el);
            }
        }

        // --- –í–°–¢–ê–í–ò–¢–¨ –≠–¢–û –í –§–£–ù–ö–¶–ò–Æ INIT() ---
        /*
        –í–Ω—É—Ç—Ä–∏ async function init() { ... } –Ω–∞–π–¥–∏ –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã –∏ –∑–∞–º–µ–Ω–∏ –Ω–∞:
        
        // Theme Load
        const sets = await getDoc(doc(db,"settings","general"));
        if(sets.exists() && sets.data().theme) {
             applyThemeLocal(sets.data().theme);
        }
        */


        // === 1. –ù–ê–°–¢–†–û–ô–ö–ò (–ö–õ–Æ–ß–ò –ò –ü–ê–†–û–õ–ò) ===
        const MY_ADMIN_PASSWORD = "123";
        
        const firebaseConfig = {
             apiKey: "AIzaSyDFrEbOwmtZlWlrPhImDlA0PE1tQKvYNAY",
             authDomain: "rakstore-a80a8.firebaseapp.com",
             projectId: "rakstore-a80a8",
             storageBucket: "rakstore-a80a8.firebasestorage.app",
             messagingSenderId: "55025016203",
             appId: "1:55025016203:web:8a6b67666dbb3df285238e"
        };

        // === 2. –ó–ê–ü–£–°–ö ===
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let myUserId = tg.initDataUnsafe?.user?.id || 11111;
        let myUsername = tg.initDataUnsafe?.user?.username || "unknown";
        if(myUsername) myUsername = myUsername.toLowerCase();
        
        // --- –°–¢–ê–†–¢–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
        async function init() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
            const sets = await getDoc(doc(db,"settings","general"));
            if(sets.exists() && sets.data().theme) document.body.className = `mode-${sets.data().theme}`;

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userRef = doc(db, "users", myUserId.toString());
            const snap = await getDoc(userRef);
            
            if(!snap.exists()) {
                // –ï—Å–ª–∏ –Ω–æ–≤—ã–π —é–∑–µ—Ä - —Å–æ–∑–¥–∞–µ–º –∏ —Ç—Ä–µ–±—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
                await setDoc(userRef, { 
                    username: myUsername, 
                    name: tg.initDataUnsafe?.user?.first_name || "Guest",
                    spent: 0, items: [], bonusBalance: 0 
                });
                showPhoneBlocker();
            } else {
                const d = snap.data();
                if(!d.phoneNumber) showPhoneBlocker(); // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - –±–ª–æ–∫
                if(d.username !== myUsername) updateDoc(userRef, { username: myUsername });
                renderUI(d);
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú ---
        
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        function showPhoneBlocker() {
            document.getElementById('phone-blocker').style.display = 'flex';
        }

        window.savePhone = async () => {
            const p = document.getElementById('mandatory-phone').value;
            if(p.length < 10) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä");
            await updateDoc(doc(db, "users", myUserId.toString()), { phoneNumber: p });
            document.getElementById('phone-blocker').style.display = 'none';
            location.reload();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        function renderUI(u) {
            // –†–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è
            const lvl = Math.floor(u.spent/100000)+1;
            document.getElementById('lvl-display').innerText = lvl;
            document.getElementById('discount-display').innerText = (lvl*5)+"%";
            document.getElementById('rub-current').innerText = (u.spent%100000).toLocaleString();
            document.getElementById('xp-fill').style.width = ((u.spent%100000)/100000*100)+"%";

            // –ü—Ä–æ—Ñ–∏–ª—å
            document.getElementById('profile-name-disp').innerText = u.customName || u.name;
            document.getElementById('profile-phone-disp').innerText = u.phoneNumber || "No Phone";
            if(u.avatarUrl) document.getElementById('profile-avatar').src = u.avatarUrl;
            document.getElementById('bonus-balance').innerText = u.bonusBalance || 0;

            // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (–®–∫–∞–ª–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏)
            const hList = document.getElementById('history-list');
            hList.innerHTML = "";
            if(u.items) {
                [...u.items].reverse().forEach(i => {
                    const now = new Date();
                    const exp = new Date(i.expiryDate);
                    const totalDur = exp - new Date(i.date);
                    const left = exp - now;
                    const daysLeft = Math.ceil(left / (1000*60*60*24));
                    
                    let barPercent = 0;
                    let label = "–ò—Å—Ç–µ–∫–ª–æ";
                    let isLow = false;

                    if(left > 0) {
                        barPercent = (left / totalDur) * 100;
                        label = `–û—Å—Ç–∞–ª–æ—Å—å: ${daysLeft} –¥–Ω.`;
                        if(barPercent < 20) isLow = true;
                    }

                    hList.innerHTML += `
                    <div class="warranty-card ${i.isGift?'gift':''}">
                        <div class="w-header">
                            <span>${i.name}</span>
                            <span>${i.isGift ? 'üéÅ' : i.price+'‚ÇΩ'}</span>
                        </div>
                        <div class="w-bar-bg">
                            <div class="w-bar-fill ${isLow?'low':''}" style="width:${barPercent}%"></div>
                        </div>
                        <div class="w-footer">
                            <span>${new Date(i.date).toLocaleDateString()}</span>
                            <span style="color:${left>0?'var(--text)':'var(--red)'}">${label}</span>
                        </div>
                        ${i.isGift ? '<div class="gift-badge">–ü–û–î–ê–†–û–ö</div>' : ''}
                    </div>`;
                });
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
        window.updateProfile = async () => {
            const cn = document.getElementById('inp-custom-name').value;
            const av = document.getElementById('inp-avatar-url').value;
            await updateDoc(doc(db,"users",myUserId.toString()), { customName: cn, avatarUrl: av });
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); location.reload();
        }

        // --- –õ–ò–î–ï–†–ë–û–†–î ---
        window.loadLeaderboard = async () => {
            const l = document.getElementById('leaderboard-list');
            l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            const q = query(collection(db,"users"), orderBy("spent","desc"), limit(10));
            const s = await getDocs(q);
            l.innerHTML = "";
            let i=1;
            s.forEach(d => {
                const u = d.data();
                l.innerHTML += `
                <div class="leader-item">
                    <div class="l-rank">${i}</div>
                    <img src="${u.avatarUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="l-avatar">
                    <div class="l-info">
                        <div class="l-name">${u.customName || u.name}</div>
                        <div class="l-spent">${u.spent.toLocaleString()}‚ÇΩ</div>
                    </div>
                </div>`;
                i++;
            });
        }

        // --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ---
        
        // –í—Ö–æ–¥
        window.adminLogin = () => {
            if(document.getElementById('adm-pass').value === MY_ADMIN_PASSWORD) {
                document.getElementById('admin-login').style.display='none';
                document.getElementById('admin-controls').style.display='block';
                loadProductsAdmin();
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        window.swTab = (id, el) => {
            document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
            el.classList.add('active');
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ (–°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤)
        async function loadProductsAdmin() {
            const list = document.getElementById('products-list');
            const sel = document.getElementById('new-prod-link');
            const issSel = document.getElementById('adm-product-select');
            
            list.innerHTML = "";
            sel.innerHTML = '<option value="">–ù–µ—Ç</option>';
            issSel.innerHTML = "";

            const snap = await getDocs(collection(db, "predefined_products"));
            snap.forEach(d => {
                const p = d.data();
                // –°–ø–∏—Å–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                list.innerHTML += `<div class="list-item-row">
                    <span>${p.name} (${p.price}‚ÇΩ) ${p.linkedId?'üîó':''}</span>
                    <div class="btn-icon btn-red" onclick="delProd('${d.id}')">üóë</div>
                </div>`;
                // –°–ø–∏—Å–∫–∏ –≤—ã–±–æ—Ä–∞
                const opt = `<option value="${d.id}">${p.name} (${p.price}‚ÇΩ)</option>`;
                sel.innerHTML += opt;
                issSel.innerHTML += opt;
            });
        }

        window.admCreateProduct = async () => {
            const n = document.getElementById('new-prod-name').value;
            const p = Number(document.getElementById('new-prod-price').value);
            const l = document.getElementById('new-prod-link').value;
            if(!n) return;
            await updateDoc(doc(collection(db,"predefined_products")), { name:n, price:p, linkedId:l });
            loadProductsAdmin();
            alert("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω");
        }
        window.delProd = async (id) => { if(confirm("Del?")) { await deleteDoc(doc(db,"predefined_products",id)); loadProductsAdmin(); }}

        // –ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞ –∏ –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–∞
        let targetUid = null;
        window.admFindUser = async () => {
            const u = document.getElementById('adm-search').value.toLowerCase().replace("@","");
            const q = query(collection(db,"users"), where("username","==",u));
            const s = await getDocs(q);
            if(s.empty) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω");
            
            const data = s.docs[0].data();
            targetUid = s.docs[0].id;
            
            document.getElementById('issue-panel').style.display = 'block';
            document.getElementById('target-real-name').innerText = data.customName || data.name;
            document.getElementById('target-phone').innerText = data.phoneNumber || "–ë–µ–∑ –Ω–æ–º–µ—Ä–∞";
            document.getElementById('target-username').innerText = "@"+data.username;
        }

        window.admGiveProduct = async () => {
            if(!targetUid) return;
            const prodId = document.getElementById('adm-product-select').value;
            const dur = Number(document.getElementById('adm-dur').value);
            const unit = document.getElementById('adm-unit').value;

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞ —Ç–æ–≤–∞—Ä–∞
            const pSnap = await getDoc(doc(db,"predefined_products",prodId));
            if(!pSnap.exists()) return;
            const prod = pSnap.data();

            // –°—á–∏—Ç–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
            let d = new Date();
            if(unit==='days') d.setDate(d.getDate()+dur);
            if(unit==='months') d.setMonth(d.getMonth()+dur);
            if(unit==='years') d.setFullYear(d.getFullYear()+dur);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–∫—É–ø–∫–∏
            const mainItem = { id: Date.now().toString(), name: prod.name, price: prod.price, date: new Date().toISOString(), expiryDate: d.toISOString(), isGift: false };
            
            const uRef = doc(db,"users",targetUid);
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –±–∞–∑—É
            await updateDoc(uRef, { items: arrayUnion(mainItem), spent: increment(prod.price) });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ü–†–ò–í–Ø–ó–ê–ù–ù–´–ô —Ç–æ–≤–∞—Ä (–ø–æ–¥–∞—Ä–æ–∫)
            if(prod.linkedId) {
                const lSnap = await getDoc(doc(db,"predefined_products",prod.linkedId));
                if(lSnap.exists()) {
                    const lProd = lSnap.data();
                    const linkedItem = { 
                        id: Date.now().toString()+"L", 
                        name: lProd.name + " (–ë–æ–Ω—É—Å)", 
                        price: 0, 
                        date: new Date().toISOString(), 
                        expiryDate: d.toISOString(), 
                        isGift: true 
                    };
                    await updateDoc(uRef, { items: arrayUnion(linkedItem) });
                    alert(`–í—ã–¥–∞–Ω ${prod.name} + ${lProd.name}!`);
                } else {
                    alert(`–í—ã–¥–∞–Ω ${prod.name}`);
                }
            } else {
                alert(`–í—ã–¥–∞–Ω ${prod.name}`);
            }
        }

        // --- –ë–û–ù–£–°–´ (–ü–†–û–ú–û) ---
        window.activatePromo = async () => {
             const c = document.getElementById('promo-input').value.toUpperCase();
             const snap = await getDoc(doc(db,"promocodes",c));
             if(snap.exists() && !snap.data().users.includes(myUserId.toString())) {
                 await updateDoc(doc(db,"users",myUserId.toString()), { bonusBalance: increment(snap.data().value) });
                 await updateDoc(doc(db,"promocodes",c), { users: arrayUnion(myUserId.toString()) });
                 alert("OK"); location.reload();
             } else alert("–û—à–∏–±–∫–∞");
        }

        // --- –¢–ï–ú–´ ---
        window.setTheme = async (t) => {
            await setDoc(doc(db,"settings","general"), {theme:t}, {merge:true});
            alert("Theme set");
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        window.navTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active'); else n.classList.remove('active');
            });
            if(id === 'leaderboard') loadLeaderboard();
        }

        init();
    </script>
</body>
</html>
